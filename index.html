<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Drama Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom styles */
        .country-korea { background-color: #f9e3e3; border-left: 4px solid #ff6b6b; }
        .country-thailand { background-color: #e3f9f5; border-left: 4px solid #48dbfb; }
        .country-japan { background-color: #f5f6fa; border-left: 4px solid #a55eea; }
        .country-china { background-color: #fff3e6; border-left: 4px solid #fd9644; }
        .country-taiwan { background-color: #e6f9ff; border-left: 4px solid #2d98da; }
        .country-philippines { background-color: #fef9e7; border-left: 4px solid #f39c12; }
        .country-vietnam { background-color: #e8f8f5; border-left: 4px solid #1abc9c; }
        .country-mexico { background-color: #fdedec; border-left: 4px solid #e74c3c; }
        
        .status-completed { color: #2ecc71; }
        .status-watching { color: #3498db; }
        .status-planned { color: #9b59b6; }
        
        .rating-stars { color: #f1c40f; }
        .rating-hearts { color: #e74c3c; }
        
        .grid-view .drama-card {
            transition: transform 0.2s;
        }
        .grid-view .drama-card:hover {
            transform: translateY(-5px);
        }
        
        /* Animation for adding new drama */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8">
            <div class="flex items-center mb-4 md:mb-0">
                <i class="fas fa-film text-3xl text-purple-600 mr-3"></i>
                <h1 class="text-3xl font-bold text-gray-800">WatchList Haven</h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <div id="userDropdown" class="hidden relative">
                    <button id="userMenuBtn" class="flex items-center space-x-2 px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition">
                        <i class="fas fa-user-circle"></i>
                        <span id="usernameDisplay">User</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="dropdownMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                        <div class="py-1">
                            <a href="#" id="syncNowBtn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-sync-alt mr-2"></i>Sync Now
                            </a>
                            <a href="#" id="logoutBtn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            </a>
                        </div>
                    </div>
                </div>
                <button id="loginBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                </button>
                <div class="relative">
                    <button id="viewToggle" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-th-large mr-2"></i>Grid View
                    </button>
                </div>
                <button id="addDramaBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-plus mr-2"></i>Add Drama
                </button>
            </div>
        </header>
        
        <!-- Search and Filter -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                <div class="relative flex-grow md:mr-4">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="searchInput" placeholder="Search dramas..." 
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                
                <div class="flex flex-wrap gap-2">
                    <select id="countryFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">All Countries</option>
                        <option value="South Korea">South Korea</option>
                        <option value="Thailand">Thailand</option>
                        <option value="Japan">Japan</option>
                        <option value="China">China</option>
                        <option value="Taiwan">Taiwan</option>
                        <option value="Philippines">Philippines</option>
                        <option value="Vietnam">Vietnam</option>
                        <option value="Mexico">Mexico</option>
                    </select>
                    
                    <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">All Statuses</option>
                        <option value="Completed">Completed</option>
                        <option value="Currently Watching">Currently Watching</option>
                        <option value="Plan to Watch">Plan to Watch</option>
                    </select>
                    
                    <select id="genreFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">All Genres</option>
                        <option value="BL">BL</option>
                        <option value="K-Drama">K-Drama</option>
                        <option value="Romance">Romance</option>
                        <option value="Comedy">Comedy</option>
                        <option value="Action">Action</option>
                        <option value="Fantasy">Fantasy</option>
                    </select>
                    
                    <select id="sortBy" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="title-asc">Sort: A-Z</option>
                        <option value="title-desc">Sort: Z-A</option>
                        <option value="rating-desc">Sort: Highest Rating</option>
                        <option value="rating-asc">Sort: Lowest Rating</option>
                        <option value="date-desc">Sort: Recently Added</option>
                        <option value="date-asc">Sort: Oldest Added</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Stats Summary -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-blue-50 p-3 rounded-lg text-center">
                <div class="text-blue-600 font-bold text-2xl" id="totalDramas">0</div>
                <div class="text-gray-600">Total Dramas</div>
            </div>
            <div class="bg-green-50 p-3 rounded-lg text-center">
                <div class="text-green-600 font-bold text-2xl" id="completedDramas">0</div>
                <div class="text-gray-600">Completed</div>
            </div>
            <div class="bg-purple-50 p-3 rounded-lg text-center">
                <div class="text-purple-600 font-bold text-2xl" id="avgRating">0</div>
                <div class="text-gray-600">Avg Rating</div>
            </div>
            <div class="bg-yellow-50 p-3 rounded-lg text-center">
                <div class="text-yellow-600 font-bold text-2xl" id="countriesCount">0</div>
                <div class="text-gray-600">Countries</div>
            </div>
        </div>
        
        <!-- Main Content -->
        <main>
            <!-- List View -->
            <div id="listView" class="hidden">
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Genre</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Country</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dramaList" class="bg-white divide-y divide-gray-200">
                            <!-- Drama entries will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Grid View -->
            <div id="gridView" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Drama cards will be inserted here -->
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12 hidden">
                <i class="fas fa-film text-5xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-medium text-gray-500">No dramas found</h3>
                <p class="text-gray-400 mt-2">Add your first drama to get started!</p>
                <button id="addFirstDramaBtn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-plus mr-2"></i>Add Drama
                </button>
            </div>
        </main>
    </div>
    
    <!-- Add Drama Modal -->
    <div id="addDramaModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b p-4">
                <h3 class="text-xl font-bold text-gray-800">Add New Drama</h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="dramaForm" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="dramaTitle" class="block text-sm font-medium text-gray-700 mb-1">Title*</label>
                        <input type="text" id="dramaTitle" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div>
                        <label for="dramaGenre" class="block text-sm font-medium text-gray-700 mb-1">Genre*</label>
                        <select id="dramaGenre" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">Select Genre</option>
                            <option value="BL">BL</option>
                            <option value="K-Drama">K-Drama</option>
                            <option value="Romance">Romance</option>
                            <option value="Comedy">Comedy</option>
                            <option value="Action">Action</option>
                            <option value="Fantasy">Fantasy</option>
                            <option value="Historical">Historical</option>
                            <option value="Thriller">Thriller</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="dramaCountry" class="block text-sm font-medium text-gray-700 mb-1">Country*</label>
                        <select id="dramaCountry" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">Select Country</option>
                            <option value="South Korea">South Korea</option>
                            <option value="Thailand">Thailand</option>
                            <option value="Japan">Japan</option>
                            <option value="China">China</option>
                            <option value="Taiwan">Taiwan</option>
                            <option value="Philippines">Philippines</option>
                            <option value="Vietnam">Vietnam</option>
                            <option value="Mexico">Mexico</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="dramaStatus" class="block text-sm font-medium text-gray-700 mb-1">Status*</label>
                        <select id="dramaStatus" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">Select Status</option>
                            <option value="Completed">Completed</option>
                            <option value="Currently Watching">Currently Watching</option>
                            <option value="Plan to Watch">Plan to Watch</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rating*</label>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <input type="radio" id="ratingTypeStars" name="ratingType" value="stars" checked 
                                       class="mr-2 focus:ring-purple-500">
                                <label for="ratingTypeStars" class="text-sm text-gray-700">Stars (1-10)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="ratingTypeHearts" name="ratingType" value="hearts" 
                                       class="mr-2 focus:ring-purple-500">
                                <label for="ratingTypeHearts" class="text-sm text-gray-700">Hearts (1-5)</label>
                            </div>
                        </div>
                        
                        <div id="starsRating" class="mt-2">
                            <div class="flex space-x-1">
                                <i class="fas fa-star text-gray-300 cursor-pointer rating-star" data-value="1"></i>
                                <i class="fas fa-star text-gray-300 cursor-pointer rating-star" data-value="2"></i>
                                <i class="fas fa-star text-gray-300 cursor-pointer rating-star" data-value="3"></i>
                                <i class="fas fa-star text-gray-300 cursor-pointer rating-star" data-value="4"></i>
                                <i class="fas fa-star text-gray-300 cursor-pointer rating-star" data-value="5"></i>
                                <i class="fas fa-star text-gray-300 cursor-pointer rating-star" data-value="6"></i>
                                <i class="fas fa-star text-gray-300 cursor-pointer rating-star" data-value="7"></i>
                                <i class="fas fa-star text-gray-300 cursor-pointer rating-star" data-value="8"></i>
                                <i class="fas fa-star text-gray-300 cursor-pointer rating-star" data-value="9"></i>
                                <i class="fas fa-star text-gray-300 cursor-pointer rating-star" data-value="10"></i>
                            </div>
                            <input type="hidden" id="starRatingValue" value="0">
                        </div>
                        
                        <div id="heartsRating" class="mt-2 hidden">
                            <div class="flex space-x-1">
                                <i class="fas fa-heart text-gray-300 cursor-pointer rating-heart" data-value="1"></i>
                                <i class="fas fa-heart text-gray-300 cursor-pointer rating-heart" data-value="2"></i>
                                <i class="fas fa-heart text-gray-300 cursor-pointer rating-heart" data-value="3"></i>
                                <i class="fas fa-heart text-gray-300 cursor-pointer rating-heart" data-value="4"></i>
                                <i class="fas fa-heart text-gray-300 cursor-pointer rating-heart" data-value="5"></i>
                            </div>
                            <input type="hidden" id="heartRatingValue" value="0">
                        </div>
                    </div>
                    
                    <div>
                        <label for="dramaImage" class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                        <input type="text" id="dramaImage" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" 
                               placeholder="Paste image URL (optional)">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="dramaDates" class="block text-sm font-medium text-gray-700 mb-1">Dates</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="dateStarted" class="block text-xs text-gray-500 mb-1">Date Started</label>
                                <input type="date" id="dateStarted" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label for="dateFinished" class="block text-xs text-gray-500 mb-1">Date Finished</label>
                                <input type="date" id="dateFinished" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="dramaNotes" class="block text-sm font-medium text-gray-700 mb-1">Notes/Review</label>
                        <textarea id="dramaNotes" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancelDramaBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        Save Drama
                    </button>
                </div>
                
                <input type="hidden" id="dramaId" value="">
            </form>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center border-b p-4">
                <h3 class="text-xl font-bold text-gray-800">Login / Register</h3>
                <button id="closeLoginModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6">
                <div class="mb-6">
                    <div class="flex border-b">
                        <button id="loginTabBtn" class="px-4 py-2 font-medium text-purple-600 border-b-2 border-purple-600">Login</button>
                        <button id="registerTabBtn" class="px-4 py-2 font-medium text-gray-500">Register</button>
                    </div>
                </div>
                
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Email*</label>
                        <input type="email" id="loginEmail" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Password*</label>
                        <input type="password" id="loginPassword" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input type="checkbox" id="rememberMe" class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                            <label for="rememberMe" class="ml-2 block text-sm text-gray-700">Remember me</label>
                        </div>
                        
                        <a href="#" class="text-sm text-purple-600 hover:text-purple-500">Forgot password?</a>
                    </div>
                    
                    <button type="submit" class="w-full py-2 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        Login
                    </button>
                </form>
                
                <form id="registerForm" class="space-y-4 hidden">
                    <div>
                        <label for="registerName" class="block text-sm font-medium text-gray-700 mb-1">Name*</label>
                        <input type="text" id="registerName" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div>
                        <label for="registerEmail" class="block text-sm font-medium text-gray-700 mb-1">Email*</label>
                        <input type="email" id="registerEmail" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div>
                        <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-1">Password*</label>
                        <input type="password" id="registerPassword" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div>
                        <label for="registerConfirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password*</label>
                        <input type="password" id="registerConfirmPassword" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <button type="submit" class="w-full py-2 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        Register
                    </button>
                </form>
                
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-600">Or continue with</p>
                    <div class="mt-2 flex justify-center space-x-4">
                        <button class="p-2 bg-blue-50 rounded-full text-blue-600 hover:bg-blue-100">
                            <i class="fab fa-facebook-f"></i>
                        </button>
                        <button class="p-2 bg-red-50 rounded-full text-red-600 hover:bg-red-100">
                            <i class="fab fa-google"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stats Modal -->
    <div id="statsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b p-4">
                <h3 class="text-xl font-bold text-gray-800">Your Drama Statistics</h3>
                <button id="closeStatsModalBtn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                        <h4 class="font-medium text-gray-700 mb-4">Drama Distribution</h4>
                        <canvas id="statusChart" height="200"></canvas>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                        <h4 class="font-medium text-gray-700 mb-4">Country Distribution</h4>
                        <canvas id="countryChart" height="200"></canvas>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg shadow border border-gray-200 mb-6">
                    <h4 class="font-medium text-gray-700 mb-4">Rating Distribution</h4>
                    <canvas id="ratingChart" height="250"></canvas>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                        <h4 class="font-medium text-gray-700 mb-4">Top Genres</h4>
                        <div id="topGenresList" class="space-y-2">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow border border-gray-200">
                        <h4 class="font-medium text-gray-700 mb-4">Recent Additions</h4>
                        <div id="recentDramasList" class="space-y-2">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Database setup
        let db;
        const DB_NAME = 'DramaTrackerDB';
        const DB_VERSION = 1;
        const DRAMA_STORE = 'dramas';
        const USER_STORE = 'users';
        
        // Initialize database
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                    reject('Database error');
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('Database initialized');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create dramas store if it doesn't exist
                    if (!db.objectStoreNames.contains(DRAMA_STORE)) {
                        const dramaStore = db.createObjectStore(DRAMA_STORE, { keyPath: 'id', autoIncrement: true });
                        dramaStore.createIndex('title', 'title', { unique: false });
                        dramaStore.createIndex('genre', 'genre', { unique: false });
                        dramaStore.createIndex('country', 'country', { unique: false });
                        dramaStore.createIndex('status', 'status', { unique: false });
                        dramaStore.createIndex('rating', 'rating', { unique: false });
                        dramaStore.createIndex('dateAdded', 'dateAdded', { unique: false });
                    }
                    
                    // Create users store if it doesn't exist
                    if (!db.objectStoreNames.contains(USER_STORE)) {
                        const userStore = db.createObjectStore(USER_STORE, { keyPath: 'id', autoIncrement: true });
                        userStore.createIndex('email', 'email', { unique: true });
                    }
                };
            });
        }
        
        // Add a new drama to the database
        function addDrama(drama) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([DRAMA_STORE], 'readwrite');
                const store = transaction.objectStore(DRAMA_STORE);
                
                // Add date added
                drama.dateAdded = new Date().toISOString();
                
                const request = store.add(drama);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }
        
        // Update an existing drama
        function updateDrama(drama) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([DRAMA_STORE], 'readwrite');
                const store = transaction.objectStore(DRAMA_STORE);
                
                const request = store.put(drama);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }
        
        // Delete a drama
        function deleteDrama(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([DRAMA_STORE], 'readwrite');
                const store = transaction.objectStore(DRAMA_STORE);
                
                const request = store.delete(id);
                
                request.onsuccess = () => {
                    resolve();
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }
        
        // Get all dramas
        function getAllDramas() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([DRAMA_STORE], 'readonly');
                const store = transaction.objectStore(DRAMA_STORE);
                
                const request = store.getAll();
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }
        
        // Get filtered dramas
        function getFilteredDramas(filters = {}) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([DRAMA_STORE], 'readonly');
                const store = transaction.objectStore(DRAMA_STORE);
                let request;
                
                if (Object.keys(filters).length === 0) {
                    request = store.getAll();
                } else {
                    // For simplicity, we'll filter in memory
                    // In a real app, you might use indexes for better performance
                    request = store.getAll();
                    
                    request.onsuccess = () => {
                        let dramas = request.result;
                        
                        if (filters.search) {
                            const searchTerm = filters.search.toLowerCase();
                            dramas = dramas.filter(drama => 
                                drama.title.toLowerCase().includes(searchTerm) || 
                                (drama.notes && drama.notes.toLowerCase().includes(searchTerm))
                            );
                        }
                        
                        if (filters.country) {
                            dramas = dramas.filter(drama => drama.country === filters.country);
                        }
                        
                        if (filters.status) {
                            dramas = dramas.filter(drama => drama.status === filters.status);
                        }
                        
                        if (filters.genre) {
                            dramas = dramas.filter(drama => drama.genre === filters.genre);
                        }
                        
                        // Sorting
                        if (filters.sortBy) {
                            const [sortField, sortDirection] = filters.sortBy.split('-');
                            
                            dramas.sort((a, b) => {
                                if (sortField === 'title') {
                                    return sortDirection === 'asc' 
                                        ? a.title.localeCompare(b.title) 
                                        : b.title.localeCompare(a.title);
                                } else if (sortField === 'rating') {
                                    return sortDirection === 'asc' 
                                        ? a.rating - b.rating 
                                        : b.rating - a.rating;
                                } else if (sortField === 'date') {
                                    return sortDirection === 'asc' 
                                        ? new Date(a.dateAdded) - new Date(b.dateAdded) 
                                        : new Date(b.dateAdded) - new Date(a.dateAdded);
                                }
                                return 0;
                            });
                        }
                        
                        resolve(dramas);
                        return;
                    };
                }
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }
        
        // User functions
        function registerUser(user) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([USER_STORE], 'readwrite');
                const store = transaction.objectStore(USER_STORE);
                
                const request = store.add(user);
                
                request.onsuccess = () => {
                    resolve(request.result);
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }
        
        function loginUser(email, password) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([USER_STORE], 'readonly');
                const store = transaction.objectStore(USER_STORE);
                const emailIndex = store.index('email');
                
                const request = emailIndex.get(email);
                
                request.onsuccess = () => {
                    const user = request.result;
                    if (user && user.password === password) {
                        resolve(user);
                    } else {
                        reject('Invalid email or password');
                    }
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }
        
        // Auth state
        let currentUser = null;
        const AUTH_TOKEN_KEY = 'dramaTrackerAuthToken';
        
        // Check if user is logged in on page load
        function checkAuthState() {
            const token = localStorage.getItem(AUTH_TOKEN_KEY);
            if (token) {
                // In a real app, you would validate the token with your backend
                currentUser = { email: token.split('|')[0] };
                updateAuthUI();
            }
        }
        
        function updateAuthUI() {
            if (currentUser) {
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('userDropdown').classList.remove('hidden');
                document.getElementById('usernameDisplay').textContent = currentUser.email.split('@')[0];
            } else {
                document.getElementById('loginBtn').classList.remove('hidden');
                document.getElementById('userDropdown').classList.add('hidden');
            }
        }
        
        // Cloud sync functions
        async function syncWithCloud() {
            if (!currentUser) return;
            
            try {
                // Get local dramas
                const localDramas = await getAllDramas();
                
                // In a real app, you would:
                // 1. Get dramas from cloud
                // 2. Merge with local dramas
                // 3. Upload merged list
                // 4. Save merged list locally
                
                alert('Data synced successfully!');
            } catch (error) {
                console.error('Sync error:', error);
                alert('Sync failed. Please check your connection.');
            }
        }
        
        // UI Functions
        function renderDramaList(dramas) {
            const listView = document.getElementById('dramaList');
            const gridView = document.getElementById('gridView');
            
            listView.innerHTML = '';
            gridView.innerHTML = '';
            
            if (dramas.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('listView').classList.add('hidden');
                document.getElementById('gridView').classList.add('hidden');
                return;
            }
            
            document.getElementById('emptyState').classList.add('hidden');
            
            // Render list view
            dramas.forEach(drama => {
                const row = document.createElement('tr');
                row.className = 'fade-in';
                
                // Get country class
                const countryClass = `country-${drama.country.toLowerCase().replace(/\s+/g, '-')}`;
                
                // Status icon
                let statusIcon = '';
                if (drama.status === 'Completed') {
                    statusIcon = '<i class="fas fa-check-circle status-completed"></i>';
                } else if (drama.status === 'Currently Watching') {
                    statusIcon = '<i class="fas fa-eye status-watching"></i>';
                } else {
                    statusIcon = '<i class="fas fa-bookmark status-planned"></i>';
                }
                
                // Rating display
                let ratingDisplay = '';
                if (drama.ratingType === 'hearts') {
                    ratingDisplay = `<span class="rating-hearts">${'<i class="fas fa-heart"></i>'.repeat(drama.rating)}${'<i class="far fa-heart"></i>'.repeat(5 - drama.rating)}</span>`;
                } else {
                    ratingDisplay = `<span class="rating-stars">${'<i class="fas fa-star"></i>'.repeat(drama.rating)}${'<i class="far fa-star"></i>'.repeat(10 - drama.rating)}</span>`;
                }
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            ${drama.image ? `<img class="h-10 w-10 rounded-full object-cover mr-4" src="${drama.image}" alt="${drama.title}">` : '<div class="h-10 w-10 rounded-full bg-gray-200 mr-4 flex items-center justify-center"><i class="fas fa-film text-gray-400"></i></div>'}
                            <div class="text-sm font-medium text-gray-900">${drama.title}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${drama.genre}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${drama.country}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm">${statusIcon} <span class="ml-1">${drama.status}</span></div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm">${ratingDisplay}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-purple-600 hover:text-purple-900 mr-3 edit-drama" data-id="${drama.id}">Edit</button>
                        <button class="text-red-600 hover:text-red-900 delete-drama" data-id="${drama.id}">Delete</button>
                    </td>
                `;
                
                listView.appendChild(row);
            });
            
            // Render grid view
            dramas.forEach(drama => {
                const card = document.createElement('div');
                card.className = 'drama-card bg-white rounded-lg shadow-md overflow-hidden fade-in';
                
                // Get country class
                const countryClass = `country-${drama.country.toLowerCase().replace(/\s+/g, '-')}`;
                
                // Status icon
                let statusIcon = '';
                if (drama.status === 'Completed') {
                    statusIcon = '<i class="fas fa-check-circle status-completed"></i>';
                } else if (drama.status === 'Currently Watching') {
                    statusIcon = '<i class="fas fa-eye status-watching"></i>';
                } else {
                    statusIcon = '<i class="fas fa-bookmark status-planned"></i>';
                }
                
                // Rating display
                let ratingDisplay = '';
                if (drama.ratingType === 'hearts') {
                    ratingDisplay = `<span class="rating-hearts">${'<i class="fas fa-heart"></i>'.repeat(drama.rating)}${'<i class="far fa-heart"></i>'.repeat(5 - drama.rating)}</span>`;
                } else {
                    ratingDisplay = `<span class="rating-stars">${'<i class="fas fa-star"></i>'.repeat(drama.rating)}${'<i class="far fa-star"></i>'.repeat(10 - drama.rating)}</span>`;
                }
                
                card.innerHTML = `
                    <div class="relative">
                        ${drama.image ? `<img class="w-full h-48 object-cover" src="${drama.image}" alt="${drama.title}">` : '<div class="w-full h-48 bg-gray-200 flex items-center justify-center"><i class="fas fa-film text-4xl text-gray-400"></i></div>'}
                        <div class="absolute top-2 right-2 bg-white bg-opacity-80 rounded-full p-1">
                            ${statusIcon}
                        </div>
                    </div>
                    <div class="p-4 ${countryClass}">
                        <h3 class="font-bold text-lg text-gray-800 mb-1 truncate">${drama.title}</h3>
                        <div class="flex justify-between items-center text-sm text-gray-600 mb-2">
                            <span>${drama.genre}</span>
                            <span>${drama.country}</span>
                        </div>
                        <div class="mb-2">
                            ${ratingDisplay}
                        </div>
                        <div class="flex justify-between">
                            <button class="text-purple-600 hover:text-purple-800 text-sm edit-drama" data-id="${drama.id}">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                            <button class="text-red-600 hover:text-red-800 text-sm delete-drama" data-id="${drama.id}">
                                <i class="fas fa-trash-alt mr-1"></i>Delete
                            </button>
                        </div>
                    </div>
                `;
                
                gridView.appendChild(card);
            });
            
            // Show the appropriate view
            if (document.getElementById('listView').classList.contains('hidden')) {
                document.getElementById('gridView').classList.remove('hidden');
            } else {
                document.getElementById('listView').classList.remove('hidden');
            }
            
            // Update stats
            updateStats(dramas);
        }
        
        function updateStats(dramas) {
            // Total dramas
            document.getElementById('totalDramas').textContent = dramas.length;
            
            // Completed dramas
            const completed = dramas.filter(d => d.status === 'Completed').length;
            document.getElementById('completedDramas').textContent = completed;
            
            // Average rating
            const ratedDramas = dramas.filter(d => d.rating > 0);
            const avgRating = ratedDramas.length > 0 
                ? (ratedDramas.reduce((sum, d) => sum + d.rating, 0) / ratedDramas.length).toFixed(1)
                : 0;
            document.getElementById('avgRating').textContent = avgRating;
            
            // Countries count
            const countries = new Set(dramas.map(d => d.country));
            document.getElementById('countriesCount').textContent = countries.size;
        }
        
        function showAddDramaModal(drama = null) {
            const modal = document.getElementById('addDramaModal');
            const form = document.getElementById('dramaForm');
            
            if (drama) {
                // Editing existing drama
                document.getElementById('dramaTitle').value = drama.title;
                document.getElementById('dramaGenre').value = drama.genre;
                document.getElementById('dramaCountry').value = drama.country;
                document.getElementById('dramaStatus').value = drama.status;
                document.getElementById('dramaImage').value = drama.image || '';
                document.getElementById('dateStarted').value = drama.dateStarted || '';
                document.getElementById('dateFinished').value = drama.dateFinished || '';
                document.getElementById('dramaNotes').value = drama.notes || '';
                document.getElementById('dramaId').value = drama.id;
                
                // Set rating type and value
                if (drama.ratingType === 'hearts') {
                    document.getElementById('ratingTypeHearts').checked = true;
                    document.getElementById('heartsRating').classList.remove('hidden');
                    document.getElementById('starsRating').classList.add('hidden');
                    
                    // Highlight hearts
                    const hearts = document.querySelectorAll('#heartsRating .rating-heart');
                    hearts.forEach((heart, index) => {
                        if (index < drama.rating) {
                            heart.classList.remove('text-gray-300');
                            heart.classList.add('text-red-500');
                        } else {
                            heart.classList.add('text-gray-300');
                            heart.classList.remove('text-red-500');
                        }
                    });
                    
                    document.getElementById('heartRatingValue').value = drama.rating;
                } else {
                    document.getElementById('ratingTypeStars').checked = true;
                    document.getElementById('starsRating').classList.remove('hidden');
                    document.getElementById('heartsRating').classList.add('hidden');
                    
                    // Highlight stars
                    const stars = document.querySelectorAll('#starsRating .rating-star');
                    stars.forEach((star, index) => {
                        if (index < drama.rating) {
                            star.classList.remove('text-gray-300');
                            star.classList.add('text-yellow-500');
                        } else {
                            star.classList.add('text-gray-300');
                            star.classList.remove('text-yellow-500');
                        }
                    });
                    
                    document.getElementById('starRatingValue').value = drama.rating;
                }
                
                // Change modal title
                modal.querySelector('h3').textContent = 'Edit Drama';
            } else {
                // Adding new drama
                form.reset();
                document.getElementById('dramaId').value = '';
                
                // Reset rating display
                const stars = document.querySelectorAll('#starsRating .rating-star');
                stars.forEach(star => {
                    star.classList.add('text-gray-300');
                    star.classList.remove('text-yellow-500');
                });
                
                const hearts = document.querySelectorAll('#heartsRating .rating-heart');
                hearts.forEach(heart => {
                    heart.classList.add('text-gray-300');
                    heart.classList.remove('text-red-500');
                });
                
                document.getElementById('starRatingValue').value = '0';
                document.getElementById('heartRatingValue').value = '0';
                
                // Change modal title
                modal.querySelector('h3').textContent = 'Add New Drama';
            }
            
            modal.classList.remove('hidden');
        }
        
        function showStatsModal(dramas) {
            const modal = document.getElementById('statsModal');
            modal.classList.remove('hidden');
            
            // Status distribution
            const statusCounts = {
                'Completed': 0,
                'Currently Watching': 0,
                'Plan to Watch': 0
            };
            
            dramas.forEach(drama => {
                statusCounts[drama.status]++;
            });
            
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#2ecc71',
                            '#3498db',
                            '#9b59b6'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Country distribution
            const countryCounts = {};
            dramas.forEach(drama => {
                countryCounts[drama.country] = (countryCounts[drama.country] || 0) + 1;
            });
            
            const countryCtx = document.getElementById('countryChart').getContext('2d');
            new Chart(countryCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(countryCounts),
                    datasets: [{
                        data: Object.values(countryCounts),
                        backgroundColor: [
                            '#ff6b6b', // Korea
                            '#48dbfb', // Thailand
                            '#a55eea', // Japan
                            '#fd9644', // China
                            '#2d98da', // Taiwan
                            '#f39c12', // Philippines
                            '#1abc9c', // Vietnam
                            '#e74c3c'  // Mexico
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Rating distribution
            const ratingCounts = {};
            dramas.forEach(drama => {
                ratingCounts[drama.rating] = (ratingCounts[drama.rating] || 0) + 1;
            });
            
            // Fill in missing ratings
            const maxRating = Math.max(...Object.keys(ratingCounts).map(Number), 10);
            for (let i = 1; i <= maxRating; i++) {
                if (!ratingCounts[i]) {
                    ratingCounts[i] = 0;
                }
            }
            
            // Sort ratings
            const sortedRatings = Object.keys(ratingCounts).sort((a, b) => a - b);
            const sortedRatingCounts = sortedRatings.map(rating => ratingCounts[rating]);
            
            const ratingCtx = document.getElementById('ratingChart').getContext('2d');
            new Chart(ratingCtx, {
                type: 'bar',
                data: {
                    labels: sortedRatings,
                    datasets: [{
                        label: 'Number of Dramas',
                        data: sortedRatingCounts,
                        backgroundColor: '#9b59b6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            // Top genres
            const genreCounts = {};
            dramas.forEach(drama => {
                genreCounts[drama.genre] = (genreCounts[drama.genre] || 0) + 1;
            });
            
            const sortedGenres = Object.entries(genreCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const topGenresList = document.getElementById('topGenresList');
            topGenresList.innerHTML = '';
            
            sortedGenres.forEach(([genre, count]) => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center';
                item.innerHTML = `
                    <span class="text-gray-700">${genre}</span>
                    <span class="bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${count}</span>
                `;
                topGenresList.appendChild(item);
            });
            
            // Recent additions
            const recentDramas = [...dramas]
                .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded))
                .slice(0, 5);
            
            const recentDramasList = document.getElementById('recentDramasList');
            recentDramasList.innerHTML = '';
            
            recentDramas.forEach(drama => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center';
                item.innerHTML = `
                    <span class="text-gray-700 truncate max-w-[180px]">${drama.title}</span>
                    <span class="text-xs text-gray-500">${new Date(drama.dateAdded).toLocaleDateString()}</span>
                `;
                recentDramasList.appendChild(item);
            });
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                checkAuthState();
                
                // Load initial dramas
                const dramas = await getAllDramas();
                renderDramaList(dramas);
                
                // View toggle
                document.getElementById('viewToggle').addEventListener('click', () => {
                    const listView = document.getElementById('listView');
                    const gridView = document.getElementById('gridView');
                    const button = document.getElementById('viewToggle');
                    
                    if (listView.classList.contains('hidden')) {
                        listView.classList.remove('hidden');
                        gridView.classList.add('hidden');
                        button.innerHTML = '<i class="fas fa-th-large mr-2"></i>Grid View';
                    } else {
                        listView.classList.add('hidden');
                        gridView.classList.remove('hidden');
                        button.innerHTML = '<i class="fas fa-list mr-2"></i>List View';
                    }
                });
                
                // Add drama button
                document.getElementById('addDramaBtn').addEventListener('click', () => showAddDramaModal());
                document.getElementById('addFirstDramaBtn').addEventListener('click', () => showAddDramaModal());
                
                // Close modal buttons
                document.getElementById('closeModalBtn').addEventListener('click', () => {
                    document.getElementById('addDramaModal').classList.add('hidden');
                });
                
                document.getElementById('cancelDramaBtn').addEventListener('click', () => {
                    document.getElementById('addDramaModal').classList.add('hidden');
                });
                
                // Rating stars interaction
                const stars = document.querySelectorAll('#starsRating .rating-star');
                stars.forEach(star => {
                    star.addEventListener('click', () => {
                        const value = parseInt(star.getAttribute('data-value'));
                        document.getElementById('starRatingValue').value = value;
                        
                        stars.forEach((s, index) => {
                            if (index < value) {
                                s.classList.remove('text-gray-300');
                                s.classList.add('text-yellow-500');
                            } else {
                                s.classList.add('text-gray-300');
                                s.classList.remove('text-yellow-500');
                            }
                        });
                    });
                });
                
                // Rating hearts interaction
                const hearts = document.querySelectorAll('#heartsRating .rating-heart');
                hearts.forEach(heart => {
                    heart.addEventListener('click', () => {
                        const value = parseInt(heart.getAttribute('data-value'));
                        document.getElementById('heartRatingValue').value = value;
                        
                        hearts.forEach((h, index) => {
                            if (index < value) {
                                h.classList.remove('text-gray-300');
                                h.classList.add('text-red-500');
                            } else {
                                h.classList.add('text-gray-300');
                                h.classList.remove('text-red-500');
                            }
                        });
                    });
                });
                
                // Rating type toggle
                document.getElementById('ratingTypeStars').addEventListener('change', () => {
                    document.getElementById('starsRating').classList.remove('hidden');
                    document.getElementById('heartsRating').classList.add('hidden');
                });
                
                document.getElementById('ratingTypeHearts').addEventListener('change', () => {
                    document.getElementById('heartsRating').classList.remove('hidden');
                    document.getElementById('starsRating').classList.add('hidden');
                });
                
                // Form submission
                document.getElementById('dramaForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const id = document.getElementById('dramaId').value;
                    const title = document.getElementById('dramaTitle').value;
                    const genre = document.getElementById('dramaGenre').value;
                    const country = document.getElementById('dramaCountry').value;
                    const status = document.getElementById('dramaStatus').value;
                    const image = document.getElementById('dramaImage').value;
                    const dateStarted = document.getElementById('dateStarted').value;
                    const dateFinished = document.getElementById('dateFinished').value;
                    const notes = document.getElementById('dramaNotes').value;
                    
                    const ratingType = document.querySelector('input[name="ratingType"]:checked').value;
                    const rating = ratingType === 'stars' 
                        ? parseInt(document.getElementById('starRatingValue').value)
                        : parseInt(document.getElementById('heartRatingValue').value);
                    
                    const drama = {
                        title,
                        genre,
                        country,
                        status,
                        rating,
                        ratingType,
                        image,
                        dateStarted,
                        dateFinished,
                        notes
                    };
                    
                    try {
                        if (id) {
                            // Update existing drama
                            drama.id = parseInt(id);
                            await updateDrama(drama);
                        } else {
                            // Add new drama
                            await addDrama(drama);
                        }
                        
                        // Refresh the list
                        const dramas = await getAllDramas();
                        renderDramaList(dramas);
                        
                        // Close the modal
                        document.getElementById('addDramaModal').classList.add('hidden');
                    } catch (error) {
                        console.error('Error saving drama:', error);
                        alert('Error saving drama. Please try again.');
                    }
                });
                
                // Edit and delete buttons (delegated events)
                document.addEventListener('click', async (e) => {
                    // Edit button
                    if (e.target.classList.contains('edit-drama') || e.target.closest('.edit-drama')) {
                        const button = e.target.classList.contains('edit-drama') ? e.target : e.target.closest('.edit-drama');
                        const id = parseInt(button.getAttribute('data-id'));
                        
                        const dramas = await getAllDramas();
                        const drama = dramas.find(d => d.id === id);
                        
                        if (drama) {
                            showAddDramaModal(drama);
                        }
                    }
                    
                    // Delete button
                    if (e.target.classList.contains('delete-drama') || e.target.closest('.delete-drama')) {
                        const button = e.target.classList.contains('delete-drama') ? e.target : e.target.closest('.delete-drama');
                        const id = parseInt(button.getAttribute('data-id'));
                        
                        if (confirm('Are you sure you want to delete this drama?')) {
                            try {
                                await deleteDrama(id);
                                
                                // Refresh the list
                                const dramas = await getAllDramas();
                                renderDramaList(dramas);
                            } catch (error) {
                                console.error('Error deleting drama:', error);
                                alert('Error deleting drama. Please try again.');
                            }
                        }
                    }
                });
                
                // Search and filter
                const searchInput = document.getElementById('searchInput');
                const countryFilter = document.getElementById('countryFilter');
                const statusFilter = document.getElementById('statusFilter');
                const genreFilter = document.getElementById('genreFilter');
                const sortBy = document.getElementById('sortBy');
                
                const applyFilters = async () => {
                    const filters = {
                        search: searchInput.value.trim(),
                        country: countryFilter.value,
                        status: statusFilter.value,
                        genre: genreFilter.value,
                        sortBy: sortBy.value
                    };
                    
                    const dramas = await getFilteredDramas(filters);
                    renderDramaList(dramas);
                };
                
                searchInput.addEventListener('input', applyFilters);
                countryFilter.addEventListener('change', applyFilters);
                statusFilter.addEventListener('change', applyFilters);
                genreFilter.addEventListener('change', applyFilters);
                sortBy.addEventListener('change', applyFilters);
                
                // Stats button
                document.getElementById('viewToggle').addEventListener('dblclick', async () => {
                    const dramas = await getAllDramas();
                    showStatsModal(dramas);
                });
                
                // Close stats modal
                document.getElementById('closeStatsModalBtn').addEventListener('click', () => {
                    document.getElementById('statsModal').classList.add('hidden');
                });
                
                // Login/Register
                document.getElementById('loginBtn').addEventListener('click', () => {
                    document.getElementById('loginModal').classList.remove('hidden');
                });
                
                document.getElementById('closeLoginModalBtn').addEventListener('click', () => {
                    document.getElementById('loginModal').classList.add('hidden');
                });
                
                // Logout handler
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    localStorage.removeItem(AUTH_TOKEN_KEY);
                    currentUser = null;
                    updateAuthUI();
                    alert('Logged out successfully');
                });
                
                // Sync handler
                document.getElementById('syncNowBtn').addEventListener('click', syncWithCloud);
                
                // User dropdown toggle
                document.getElementById('userMenuBtn').addEventListener('click', () => {
                    document.getElementById('dropdownMenu').classList.toggle('hidden');
                });
                
                document.getElementById('loginTabBtn').addEventListener('click', () => {
                    document.getElementById('loginForm').classList.remove('hidden');
                    document.getElementById('registerForm').classList.add('hidden');
                    document.getElementById('loginTabBtn').classList.add('border-purple-600', 'text-purple-600');
                    document.getElementById('loginTabBtn').classList.remove('text-gray-500');
                    document.getElementById('registerTabBtn').classList.remove('border-purple-600', 'text-purple-600');
                    document.getElementById('registerTabBtn').classList.add('text-gray-500');
                });
                
                document.getElementById('registerTabBtn').addEventListener('click', () => {
                    document.getElementById('registerForm').classList.remove('hidden');
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('registerTabBtn').classList.add('border-purple-600', 'text-purple-600');
                    document.getElementById('registerTabBtn').classList.remove('text-gray-500');
                    document.getElementById('loginTabBtn').classList.remove('border-purple-600', 'text-purple-600');
                    document.getElementById('loginTabBtn').classList.add('text-gray-500');
                });
                
                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    
                    try {
                        const user = await loginUser(email, password);
                        currentUser = user;
                        // In a real app, you would get a proper auth token from your backend
                        localStorage.setItem(AUTH_TOKEN_KEY, `${user.email}|${Date.now()}`);
                        updateAuthUI();
                        alert(`Welcome back, ${user.email}!`);
                        document.getElementById('loginModal').classList.add('hidden');
                        
                        // In a real app, you would store the auth token and update UI
                    } catch (error) {
                        alert(error);
                    }
                });
                
                document.getElementById('registerForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById('registerName').value;
                    const email = document.getElementById('registerEmail').value;
                    const password = document.getElementById('registerPassword').value;
                    const confirmPassword = document.getElementById('registerConfirmPassword').value;
                    
                    if (password !== confirmPassword) {
                        alert('Passwords do not match');
                        return;
                    }
                    
                    const user = {
                        name,
                        email,
                        password,
                        dateRegistered: new Date().toISOString()
                    };
                    
                    try {
                        await registerUser(user);
                        alert('Registration successful! Please login.');
                        document.getElementById('loginTabBtn').click();
                        document.getElementById('loginEmail').value = email;
                    } catch (error) {
                        alert('Registration failed. Email may already be in use.');
                    }
                });
                
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to initialize the application. Please try again.');
            }
        });
    </script>
<p style="border-radius: 8px; text-align: center; font-size: 12px; color: #fff; margin-top: 16px;position: fixed; left: 8px; bottom: 8px; z-index: 10; background: rgba(0, 0, 0, 0.8); padding: 4px 8px;">Made with <img src="https://enzostvs-deepsite.hf.space/logo.svg" alt="DeepSite Logo" style="width: 16px; height: 16px; vertical-align: middle;display:inline-block;margin-right:3px;filter:brightness(0) invert(1);"><a href="https://enzostvs-deepsite.hf.space" style="color: #fff;text-decoration: underline;" target="_blank" >DeepSite</a> -  <a href="https://enzostvs-deepsite.hf.space?remix=Letticia/letticia-s-vault" style="color: #fff;text-decoration: underline;" target="_blank" >Remix</a></p></body>
</html>